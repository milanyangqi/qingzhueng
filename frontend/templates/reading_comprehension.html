<!doctype html>
<html lang=zh-CN>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>英语阅读理解生成工具</title>
<style>
body {
    margin: 0;
    padding: 0;
    background: #f5f5f5;
    font-family: "Microsoft YaHei", Arial, sans-serif;
}

.container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    position: relative;
    padding: 40px 20px;
}

.content-area {
    width: 100%;
    max-width: 1200px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 30px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
}

.header h1 {
    color: #1976d2;
    margin-bottom: 10px;
}

.header p {
    color: #666;
    font-size: 16px;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #333;
}

input[type=text], textarea, select {
    width: 100%;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

input[type=text]:focus, textarea:focus, select:focus {
    border-color: #1976d2;
    outline: none;
}

textarea {
    min-height: 200px;
    resize: vertical;
}

.btn {
    background: #1976d2;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
    display: block;
    width: 100%;
    text-align: center;
}

.btn:hover {
    background: #1565c0;
}

.btn-secondary {
    background: #4caf50;
}

.btn-secondary:hover {
    background: #388e3c;
}

.btn-group {
    display: flex;
    gap: 15px;
}

.btn-group .btn {
    flex: 1;
}



.preview-area h2 {
    color: #1976d2;
    margin-bottom: 20px;
}

.loading {
    display: none;
    text-align: center;
    padding: 20px;
}

.loading-spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid #1976d2;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.options-section {
    margin-bottom: 25px;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
}

.model-selection {
    margin-top: 10px;
}

.model-selection select {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
    background-color: #fff;
    min-width: 150px;
    font-size: 14px;
}

.options-section h3 {
    margin-top: 0;
    color: #333;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.option-item {
    display: flex;
    align-items: center;
}

.option-item input[type="checkbox"] {
    margin-right: 8px;
}

.preview-area {
    margin-top: 30px;
    border-top: 1px solid #eee;
    padding-top: 30px;
    display: flex;
    gap: 20px;
}

.preview-content-container {
    flex: 1;
}

.format-controls-container {
    width: 300px;
    flex-shrink: 0;
}

.format-controls {
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
    margin-bottom: 20px;
}

.format-control-item {
    margin-bottom: 15px;
}

.question-options {
    margin-left: 20px;
    margin-top: 5px;
}

.question-option {
    margin-bottom: 5px;
}
</style>
</head>
<body>
<div class="container">
    <div class="content-area">
        <div class="header">
            <h1>英语阅读理解生成工具</h1>
            <p>输入文章标题和内容，生成专业的英语阅读理解练习</p>
        </div>
        
        <div class="alert alert-success" id="success-alert">操作成功！</div>
        <div class="alert alert-error" id="error-alert">操作失败！</div>
        
        <div class="form-group model-selection" style="margin-bottom: 15px;">
            <label for="ai-model">选择AI模型：</label>
            <select id="ai-model" class="form-control">
                <option value="openai">OpenAI</option>
                <option value="deepseek">DeepSeek</option>
                <option value="doubao">豆包</option>
                <option value="qianwen">通义千问</option>
                <option value="siliconflow">硅基流动</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="article-title">文章标题</label>
            <input type="text" id="article-title" placeholder="请输入文章标题">
        </div>
        
        <div class="form-group">
            <label for="article-content">文章内容</label>
            <textarea id="article-content" placeholder="请输入文章内容（英文）"></textarea>
            <button class="btn" id="generate-content-btn" style="margin-top: 10px; background-color: #ff9800;">AI生成语料</button>
        </div>
        
        <div class="options-section">
            <h3>阅读理解选项</h3>
            <div class="options-grid">
                <div class="option-item">
                    <input type="checkbox" id="option-vocabulary" checked>
                    <label for="option-vocabulary">生成词汇表</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="option-key-words" checked>
                    <label for="option-key-words">提取重点单词</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="option-questions" checked>
                    <label for="option-questions">生成理解问题</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="option-translation" checked>
                    <label for="option-translation">包含中文翻译</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="option-answers" checked>
                    <label for="option-answers">包含答案解析</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="option-phonetic" checked>
                    <label for="option-phonetic">单词包含音标</label>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="question-count-selector" style="min-width: 200px;">
                    <label for="question-count">问题数量：</label>
                    <select id="question-count" style="width: 100px;">
                        <option value="3">3题</option>
                        <option value="4">4题</option>
                        <option value="5" selected>5题</option>
                        <option value="6">6题</option>
                        <option value="7">7题</option>
                        <option value="8">8题</option>
                        <option value="9">9题</option>
                        <option value="10">10题</option>
                    </select>
                </div>
                
                <div class="key-words-input" style="flex-grow: 1; display: none;">
                    <label for="manual-key-words">手动输入重点单词（用逗号分隔）：</label>
                    <input type="text" id="manual-key-words" placeholder="例如: comprehension, vocabulary, article" style="width: 100%; margin-top: 5px;">
                </div>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn" id="generate-btn">生成阅读理解</button>
        </div>
        
        <div class="loading" id="loading-indicator">
            <div class="loading-spinner"></div>
            <p>正在生成阅读理解，请稍候...</p>
        </div>
        
        <div class="preview-area" id="preview-area">
            <h2>预览</h2>
            <div style="display: flex; gap: 20px;">
                <div class="preview-content-container" style="flex: 1;">
                    <div id="preview-content"></div>
                </div>
                
                <div class="format-controls-container" style="width: 250px;">
                    <div class="format-controls" style="position: sticky; top: 20px;">
                        <h3 style="margin-top: 0; margin-bottom: 15px;">格式调整</h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">以下格式调整仅应用于文章正文</p>
                        
                        <div class="format-control-item">
                            <label for="font-size">字体大小：</label>
                            <input type="number" id="font-size" min="12" max="24" value="16" style="width: 60px;">
                            <span>px</span>
                        </div>
                        
                        <div class="format-control-item">
                            <label for="text-color">文本颜色：</label>
                            <input type="color" id="text-color" value="#333333">
                        </div>
                        
                        <div class="format-control-item">
                            <label for="keyword-color">重点单词标记颜色：</label>
                            <input type="color" id="keyword-color" value="#ff5722">
                        </div>
                        
                        <div class="format-control-item">
                            <label for="line-height">行间距：</label>
                            <input type="number" id="line-height" min="1" max="3" step="0.1" value="1.6" style="width: 60px;">
                        </div>
                        
                        <div class="format-control-item">
                            <label for="font-family">字体：</label>
                            <select id="font-family">
                                <option value="'Microsoft YaHei', Arial, sans-serif">微软雅黑</option>
                                <option value="'SimSun', serif">宋体</option>
                                <option value="'KaiTi', serif">楷体</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                            </select>
                        </div>
                        
                        <div class="format-control-item">
                            <label for="background-color">背景颜色：</label>
                            <input type="color" id="background-color" value="#ffffff">
                        </div>
                        
                        <button class="btn" id="apply-format-btn" style="margin-top: 10px;">应用格式</button>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 30px; margin-bottom: 30px;">
            <button class="btn" id="export-pdf-btn" style="display: inline-block; width: auto; padding-left: 30px; padding-right: 30px;">导出PDF</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-btn');
    const generateContentBtn = document.getElementById('generate-content-btn');
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const titleInput = document.getElementById('article-title');
    const contentInput = document.getElementById('article-content');
    const loadingIndicator = document.getElementById('loading-indicator');
    const previewArea = document.getElementById('preview-area');
    const previewContent = document.getElementById('preview-content');
    const successAlert = document.getElementById('success-alert');
    const errorAlert = document.getElementById('error-alert');
    const keyWordsOption = document.getElementById('option-key-words');
    const keyWordsInput = document.querySelector('.key-words-input');
    const applyFormatBtn = document.getElementById('apply-format-btn');
    
    // 重点单词选项切换显示手动输入框
    keyWordsOption.addEventListener('change', function() {
        keyWordsInput.style.display = this.checked ? 'block' : 'none';
    });
    
    // 初始化显示状态
    keyWordsInput.style.display = keyWordsOption.checked ? 'block' : 'none';
    
    // 初始隐藏预览区域
    previewArea.style.display = 'none';
    
    // 检查是否有从 lexile_article.html 页面导入的文章数据
    const importedTitle = localStorage.getItem('importedArticleTitle');
    const importedContent = localStorage.getItem('importedArticleContent');
    
    if (importedTitle && importedContent) {
        // 填充导入的文章标题和内容
        titleInput.value = importedTitle;
        contentInput.value = importedContent;
        
        // 清除 localStorage 中的数据，避免重复导入
        localStorage.removeItem('importedArticleTitle');
        localStorage.removeItem('importedArticleContent');
        
        // 显示导入成功提示
        showAlert('文章已成功导入，可以继续生成阅读理解', 'success');
    }
    
    // 生成阅读理解
    generateBtn.addEventListener('click', function() {
        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        
        if (!title) {
            showAlert('请输入文章标题', 'error');
            return;
        }
        
        if (!content) {
            showAlert('请输入文章内容', 'error');
            return;
        }
        
        // 获取选项
        const aiModel = document.getElementById('ai-model').value;
        const questionCount = parseInt(document.getElementById('question-count').value);
        
        const options = {
            vocabulary: document.getElementById('option-vocabulary').checked,
            questions: document.getElementById('option-questions').checked,
            translation: document.getElementById('option-translation').checked,
            answers: document.getElementById('option-answers').checked,
            keyWords: document.getElementById('option-key-words').checked,
            phonetic: document.getElementById('option-phonetic').checked,
            model: aiModel,
            questionCount: questionCount, // 使用选择的问题数量
            withOptions: true // 添加选项标志，表示每个问题需要生成4个选项
        };
        
        // 如果启用了重点单词且有手动输入，则添加到选项中
        if (options.keyWords && document.getElementById('manual-key-words').value.trim()) {
            options.manualKeyWords = document.getElementById('manual-key-words').value.trim().split(',').map(word => word.trim());
        }
        
        // 显示加载指示器
        loadingIndicator.style.display = 'block';
        
        // 调用后端API
        fetch('/generate_comprehension', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                content: content,
                options: options
            })
        })
        .then(response => response.json())
        .then(data => {
            // 隐藏加载指示器
            loadingIndicator.style.display = 'none';
            
            if (data.success) {
                // 显示预览区域
                previewArea.style.display = 'block';
                
                // 使用API返回的数据生成预览内容
                const previewHTML = generatePreviewHTMLFromAPI(data.data);
                previewContent.innerHTML = previewHTML;
                
                showAlert(data.message, 'success');
            } else {
                showAlert(data.message || '生成失败，请重试', 'error');
            }
        })
        .catch(error => {
            // 隐藏加载指示器
            loadingIndicator.style.display = 'none';
            console.error('Error:', error);
            showAlert('请求失败，请检查网络连接', 'error');
        });
    });
    
    // AI生成语料
    generateContentBtn.addEventListener('click', function() {
        const title = titleInput.value.trim();
        
        if (!title) {
            showAlert('请先输入文章标题', 'error');
            return;
        }
        
        // 获取选择的AI模型
        const aiModel = document.getElementById('ai-model').value;
        
        // 跳转到lexile_article.html页面
        window.location.href = '/lexile_article';
    });
    
    // 导出PDF
    exportPdfBtn.addEventListener('click', function() {
        if (previewArea.style.display === 'none') {
            showAlert('请先生成阅读理解内容', 'error');
            return;
        }
        
        showAlert('PDF导出功能即将实现', 'success');
        // 这里将来实现PDF导出功能
    });
    
    // 应用格式调整
    applyFormatBtn.addEventListener('click', function() {
        if (previewArea.style.display === 'none') {
            showAlert('请先生成阅读理解内容', 'error');
            return;
        }
        
        const fontSize = document.getElementById('font-size').value;
        const textColor = document.getElementById('text-color').value;
        const keywordColor = document.getElementById('keyword-color').value;
        const lineHeight = document.getElementById('line-height').value;
        const fontFamily = document.getElementById('font-family').value;
        const backgroundColor = document.getElementById('background-color').value;
        
        // 获取预览内容区域
        const previewContentDiv = document.getElementById('preview-content');
        
        // 只对文章正文内容应用格式调整
        const articleContentDivs = previewContentDiv.querySelectorAll('.article-content');
        articleContentDivs.forEach(articleDiv => {
            // 应用字体大小、文本颜色、行高和字体
            const contentTextDiv = articleDiv.querySelector('.content-text');
            if (contentTextDiv) {
                contentTextDiv.style.fontSize = `${fontSize}px`;
                contentTextDiv.style.color = textColor;
                contentTextDiv.style.lineHeight = lineHeight;
                contentTextDiv.style.fontFamily = fontFamily;
                contentTextDiv.style.backgroundColor = backgroundColor;
            }
        });
        
        // 应用重点单词标记颜色（只在文章正文中）
        const articleKeywords = previewContentDiv.querySelectorAll('.article-content .keyword');
        articleKeywords.forEach(element => {
            element.style.color = keywordColor;
            element.style.fontWeight = 'bold';
        });
        
        showAlert('格式已应用', 'success');
    });
    
    // 显示提示信息
    function showAlert(message, type) {
        const alert = type === 'success' ? successAlert : errorAlert;
        alert.textContent = message;
        alert.style.display = 'block';
        
        setTimeout(function() {
            alert.style.display = 'none';
        }, 3000);
    }
    
    // 生成预览HTML（示例 - 用于备份）
    function generatePreviewHTML(title, content) {
        // 分析文章内容，提取段落
        const paragraphs = content.split('\n').filter(p => p.trim().length > 0);
        
        // 生成问题（示例）
        const questions = [
            '1. What is the main idea of this article?',
            '2. According to the passage, what are the key points mentioned?',
            '3. What conclusion can be drawn from the article?',
            '4. How does the author support their argument?'
        ];
        
        // 生成词汇表（示例）
        const vocabulary = [
            { word: 'comprehension', translation: '理解，领悟', definition: 'the ability to understand' },
            { word: 'generate', translation: '生成，产生', definition: 'to produce or create' },
            { word: 'article', translation: '文章，论文', definition: 'a piece of writing' },
            { word: 'preview', translation: '预览，预视', definition: 'an opportunity to view something before it is acquired or becomes generally available' }
        ];
        
        // 构建HTML
        let html = `
            <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                <h2 style="color: #1976d2; text-align: center;">${title}</h2>
                <div style="line-height: 1.6;">
        `;
        
        // 添加文章内容
        paragraphs.forEach(paragraph => {
            html += `<p>${paragraph}</p>`;
        });
        
        html += `</div></div>`;
        
        // 添加重点单词部分
        if (document.getElementById('option-key-words').checked && data.keyWords && data.keyWords.length > 0) {
            html += `
                <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #1976d2;">重点单词</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            `;
            
            data.keyWords.forEach(word => {
                if (typeof word === 'object') {
                    const phonetic = document.getElementById('option-phonetic').checked && word.phonetic ? ` <span style="color: #666;">${word.phonetic}</span>` : '';
                    html += `
                        <div style="padding: 8px 15px; background: #f5f5f5; border-radius: 4px;">
                            <span class="keyword" style="font-weight: bold;">${word.word}</span>${phonetic}
                            <div>${word.translation || ''}</div>
                        </div>
                    `;
                } else if (typeof word === 'string') {
                    // 如果只有单词字符串，尝试从词汇表中找到对应信息
                    const vocabItem = data.vocabulary ? data.vocabulary.find(v => v.word.toLowerCase() === word.toLowerCase()) : null;
                    const translation = vocabItem ? vocabItem.translation : '';
                    const phonetic = document.getElementById('option-phonetic').checked && vocabItem && vocabItem.phonetic ? ` <span style="color: #666;">${vocabItem.phonetic}</span>` : '';
                    
                    html += `
                        <div style="padding: 8px 15px; background: #f5f5f5; border-radius: 4px;">
                            <span class="keyword" style="font-weight: bold;">${word}</span>${phonetic}
                            <div>${translation}</div>
                        </div>
                    `;
                }
            });
            
            html += `</div></div>`;
        }
        
        // 添加问题部分
        if (document.getElementById('option-questions').checked) {
            html += `
                <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #1976d2;">Reading Comprehension Questions</h3>
                    <ul style="line-height: 1.6;">
            `;
            
            questions.forEach(question => {
                html += `<li>${question}</li>`;
            });
            
            html += `</ul></div>`;
        }
        
        // 添加词汇表部分
        if (document.getElementById('option-vocabulary').checked) {
            html += `
                <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                    <h3 style="color: #1976d2;">Vocabulary</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Word</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Translation</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Definition</th>
                        </tr>
            `;
            
            vocabulary.forEach(item => {
                html += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${item.word}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${item.translation}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${item.definition}</td>
                    </tr>
                `;
            });
            
            html += `</table></div>`;
        }
        
        return html;
    }
    
    // 从API响应生成预览HTML
    function generatePreviewHTMLFromAPI(data) {
        try {
            // 分析文章内容，提取段落
            const paragraphs = data.content.split('\n').filter(p => p.trim().length > 0);
            
            // 获取使用的AI模型
            const modelName = data.model || 'openai';
            let modelDisplayName = '';
            
            switch(modelName) {
                case 'openai':
                    modelDisplayName = 'OpenAI';
                    break;
                case 'deepseek':
                    modelDisplayName = 'DeepSeek';
                    break;
                case 'doubao':
                    modelDisplayName = '豆包';
                    break;
                case 'qianwen':
                    modelDisplayName = '通义千问';
                    break;
                case 'siliconflow':
                    modelDisplayName = '硅基流动';
                    break;
                default:
                    modelDisplayName = modelName;
            }
            
            // 提取重点单词（如果有）
            let keyWords = [];
            if (data.keyWords && Array.isArray(data.keyWords)) {
                keyWords = data.keyWords;
            } else if (data.vocabulary && Array.isArray(data.vocabulary)) {
                // 如果没有专门的重点单词，使用词汇表中的单词
                keyWords = data.vocabulary.map(item => item.word);
            }
            
            // 构建HTML
            let html = `
                <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;" class="article-content">
                    <h2 style="color: #1976d2; text-align: center;">${data.title}</h2>
                    <div style="line-height: 1.6;" class="content-text">
            `;
            
            // 添加文章内容，并标记重点单词
            let articleContent = paragraphs.join('</p><p>');
            
            // 标记重点单词
            if (keyWords.length > 0) {
                keyWords.forEach(word => {
                    if (typeof word === 'string') {
                        const regex = new RegExp(`\\b${word}\\b`, 'gi');
                        articleContent = articleContent.replace(regex, `<span class="keyword">$&</span>`);
                    }
                });
            }
            
            html += `<p>${articleContent}</p>`;
            html += `</div></div>`;
            
            // 添加问题部分
            if (document.getElementById('option-questions').checked && data.questions && data.questions.length > 0) {
                html += `
                    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2;">阅读理解问题</h3>
                        <ol style="line-height: 1.6;">
                `;
                
                data.questions.forEach((question, index) => {
                    // 检查问题是否是对象格式（包含问题和选项）
                    if (typeof question === 'object' && question.question) {
                        let questionHtml = `<li>${question.question}</li>`;
                        
                        // 如果有选项，添加选项
                        if (question.options && question.options.length > 0) {
                            questionHtml += `<div class="question-options">`;
                            question.options.forEach((option, optIndex) => {
                                const optionLabel = String.fromCharCode(65 + optIndex); // A, B, C, D
                                questionHtml += `<div class="question-option">${optionLabel}. ${option}</div>`;
                            });
                            questionHtml += `</div>`;
                        }
                        
                        html += questionHtml;
                    } else {
                        // 如果是简单字符串格式
                        html += `<li>${question}</li>`;
                    }
                });
                
                html += `</ol></div>`;
            }
            
            // 添加词汇表部分
            if (document.getElementById('option-vocabulary').checked && data.vocabulary && data.vocabulary.length > 0) {
                html += `
                    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2;">词汇</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Word</th>
                                ${document.getElementById('option-phonetic').checked ? '<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Phonetic</th>' : ''}
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Translation</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Definition</th>
                            </tr>
                `;
                
                data.vocabulary.forEach(item => {
                    html += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;" class="keyword">${item.word}</td>
                            ${document.getElementById('option-phonetic').checked ? 
                                `<td style="border: 1px solid #ddd; padding: 8px;">${item.phonetic || ''}</td>` : ''}
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.translation}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.definition}</td>
                        </tr>
                    `;
                });
                
                html += `</table></div>`;
            }
            
            // 添加答案部分
            if (document.getElementById('option-answers').checked && data.answers && data.answers.length > 0) {
                html += `
                    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2;">答案</h3>
                        <ol style="line-height: 1.6;">
                `;
                
                data.answers.forEach(answer => {
                    html += `<li>${answer}</li>`;
                });
                
                html += `</ol></div>`;
            }
            
            // 添加翻译部分
            if (document.getElementById('option-translation').checked && data.translation) {
                html += `
                    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2;">参考译文</h3>
                        <div style="line-height: 1.6;">
                            <p>${data.translation.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            }
            
            // 如果解析失败，显示原始生成内容
            if (data.raw_generated_content && 
                ((data.questions && data.questions.length === 1 && data.questions[0].includes('解析失败')) || 
                 (data.vocabulary && data.vocabulary.length === 1 && data.vocabulary[0].word.includes('解析失败')))) {
                html += `
                    <div style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #1976d2;">原始生成内容</h3>
                        <pre style="white-space: pre-wrap; line-height: 1.6; background: #f5f5f5; padding: 15px; border-radius: 5px;">${data.raw_generated_content}</pre>
                    </div>
                `;
            }
            
            return html;
        } catch (error) {
            console.error('Error generating preview HTML:', error);
            // 如果解析失败，直接显示原始内容
            return `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
    }
});
</script>
</body>
</html>